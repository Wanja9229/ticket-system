from typing import Optional, List, Dict, Any
from sqlalchemy.orm import Session, joinedload
from sqlalchemy import and_, or_, func
from fastapi import HTTPException, status

from app.models.product import Product, ProductOption
from app.models.event import Event
from app.schemas.product import (
    ProductCreate, ProductUpdate, ProductOptionCreate, ProductOptionUpdate,
    StockAdjustment, ProductOptionStockAdjustment, PriceCalculationResponse
)


class ProductService:
    
    def __init__(self, db: Session):
        self.db = db
    
    def get_products(
        self,
        skip: int = 0,
        limit: int = 20,
        event_id: Optional[int] = None,
        search: Optional[str] = None,
        is_active: Optional[bool] = None,
        has_stock: Optional[bool] = None
    ) -> tuple[List[Product], int]:
        """상품 목록 조회 with 필터링"""
        query = self.db.query(Product).filter(Product.is_deleted == 'N')
        
        # 이벤트 필터
        if event_id:
            query = query.filter(Product.event_id == event_id)
        
        # 검색 조건
        if search:
            query = query.filter(Product.name.ilike(f"%{search}%"))
        
        # 활성화 상태 필터
        if is_active is not None:
            query = query.filter(Product.is_active == is_active)
        
        # 재고 있는 것만 필터
        if has_stock:
            query = query.filter(Product.current_stock > 0)
        
        # 전체 개수
        total = query.count()
        
        # 페이지네이션 및 옵션 함께 로드
        products = query.options(joinedload(Product.options.and_(
            ProductOption.is_deleted == 'N'
        ))).offset(skip).limit(limit).all()
        
        return products, total
    
    def get_product_by_id(self, product_id: int) -> Optional[Product]:
        """ID로 상품 조회"""
        return self.db.query(Product).options(
            joinedload(Product.options.and_(ProductOption.is_deleted == 'N')),
            joinedload(Product.event)
        ).filter(
            Product.id == product_id,
            Product.is_deleted == 'N'
        ).first()
    
    def create_product(self, product_data: ProductCreate, created_by: int) -> Product:
        """새 상품 생성"""
        # 이벤트 존재 확인
        event = self.db.query(Event).filter(
            Event.id == product_data.event_id,
            Event.is_deleted == 'N'
        ).first()
        
        if not event:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="이벤트를 찾을 수 없습니다"
            )
        
        # 같은 이벤트 내 상품명 중복 체크
        existing_product = self.db.query(Product).filter(
            Product.event_id == product_data.event_id,
            Product.name == product_data.name,
            Product.is_deleted == 'N'
        ).first()
        
        if existing_product:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"이벤트 내 동일한 상품명이 이미 존재합니다: {product_data.name}"
            )
        
        # 상품 생성
        db_product = Product(
            event_id=product_data.event_id,
            name=product_data.name,
            description=product_data.description,
            base_price=product_data.base_price,
            base_stock=product_data.base_stock,
            current_stock=product_data.current_stock,
            is_active=product_data.is_active,
            created_by=created_by
        )
        
        self.db.add(db_product)
        self.db.flush()  # ID 생성을 위해 flush
        
        # 옵션 생성
        if product_data.options:
            for option_data in product_data.options:
                db_option = ProductOption(
                    product_id=db_product.id,
                    option_name=option_data.option_name,
                    price_adjustment=option_data.price_adjustment,
                    stock_quantity=option_data.stock_quantity,
                    current_stock=option_data.current_stock,
                    is_active=option_data.is_active
                )
                self.db.add(db_option)
        
        self.db.commit()
        self.db.refresh(db_product)
        
        # 옵션과 함께 로드
        return self.get_product_by_id(db_product.id)
    
    def update_product(self, product_id: int, product_data: ProductUpdate) -> Product:
        """상품 정보 수정"""
        db_product = self.get_product_by_id(product_id)
        if not db_product:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="상품을 찾을 수 없습니다"
            )
        
        # 상품명 중복 체크 (같은 이벤트 내에서)
        if product_data.name:
            existing_product = self.db.query(Product).filter(
                Product.event_id == db_product.event_id,
                Product.name == product_data.name,
                Product.is_deleted == 'N',
                Product.id != product_id
            ).first()
            
            if existing_product:
                raise HTTPException(
                    status_code=status.HTTP_400_BAD_REQUEST,
                    detail=f"이벤트 내 동일한 상품명이 이미 존재합니다: {product_data.name}"
                )
        
        # 필드 업데이트
        update_data = product_data.model_dump(exclude_unset=True)
        for field, value in update_data.items():
            setattr(db_product, field, value)
        
        self.db.commit()
        self.db.refresh(db_product)
        
        return self.get_product_by_id(product_id)
    
    def delete_product(self, product_id: int) -> bool:
        """상품 삭제 (소프트 삭제)"""
        db_product = self.get_product_by_id(product_id)
        if not db_product:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="상품을 찾을 수 없습니다"
            )
        
        # 주문된 상품인지 확인 (실무적 고려사항)
        from app.models.order import OrderItem
        order_count = self.db.query(OrderItem).filter(
            OrderItem.product_id == product_id
        ).count()
        
        if order_count > 0:
            # 주문이 있는 상품은 비활성화만
            db_product.is_active = False
            self.db.commit()
            return True
        
        # 주문이 없는 상품은 소프트 삭제
        db_product.is_deleted = 'Y'
        db_product.is_active = False
        
        # 연관된 옵션들도 소프트 삭제
        self.db.query(ProductOption).filter(
            ProductOption.product_id == product_id
        ).update({
            'is_deleted': 'Y',
            'is_active': False
        })
        
        self.db.commit()
        return True
    
    def adjust_stock(self, product_id: int, adjustment: StockAdjustment) -> Product:
        """상품 재고 조정"""
        db_product = self.get_product_by_id(product_id)
        if not db_product:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="상품을 찾을 수 없습니다"
            )
        
        new_stock = db_product.current_stock + adjustment.quantity
        if new_stock < 0:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"재고가 부족합니다. 현재 재고: {db_product.current_stock}, 요청 조정: {adjustment.quantity}"
            )
        
        db_product.current_stock = new_stock
        self.db.commit()
        self.db.refresh(db_product)
        
        # TODO: 재고 조정 로그 기록 (ActivityLog)
        
        return self.get_product_by_id(product_id)
    
    # ProductOption CRUD
    def create_product_option(self, product_id: int, option_data: ProductOptionCreate) -> ProductOption:
        """상품 옵션 생성"""
        # 상품 존재 확인
        product = self.get_product_by_id(product_id)
        if not product:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="상품을 찾을 수 없습니다"
            )
        
        # 같은 상품 내 옵션명 중복 체크
        existing_option = self.db.query(ProductOption).filter(
            ProductOption.product_id == product_id,
            ProductOption.option_name == option_data.option_name,
            ProductOption.is_deleted == 'N'
        ).first()
        
        if existing_option:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"동일한 옵션명이 이미 존재합니다: {option_data.option_name}"
            )
        
        db_option = ProductOption(
            product_id=product_id,
            option_name=option_data.option_name,
            price_adjustment=option_data.price_adjustment,
            stock_quantity=option_data.stock_quantity,
            current_stock=option_data.current_stock,
            is_active=option_data.is_active
        )
        
        self.db.add(db_option)
        self.db.commit()
        self.db.refresh(db_option)
        
        return db_option
    
    def update_product_option(self, option_id: int, option_data: ProductOptionUpdate) -> ProductOption:
        """상품 옵션 수정"""
        db_option = self.db.query(ProductOption).filter(
            ProductOption.id == option_id,
            ProductOption.is_deleted == 'N'
        ).first()
        
        if not db_option:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="상품 옵션을 찾을 수 없습니다"
            )
        
        # 옵션명 중복 체크
        if option_data.option_name:
            existing_option = self.db.query(ProductOption).filter(
                ProductOption.product_id == db_option.product_id,
                ProductOption.option_name == option_data.option_name,
                ProductOption.is_deleted == 'N',
                ProductOption.id != option_id
            ).first()
            
            if existing_option:
                raise HTTPException(
                    status_code=status.HTTP_400_BAD_REQUEST,
                    detail=f"동일한 옵션명이 이미 존재합니다: {option_data.option_name}"
                )
        
        # 필드 업데이트
        update_data = option_data.model_dump(exclude_unset=True)
        for field, value in update_data.items():
            setattr(db_option, field, value)
        
        self.db.commit()
        self.db.refresh(db_option)
        
        return db_option
    
    def delete_product_option(self, option_id: int) -> bool:
        """상품 옵션 삭제"""
        db_option = self.db.query(ProductOption).filter(
            ProductOption.id == option_id,
            ProductOption.is_deleted == 'N'
        ).first()
        
        if not db_option:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="상품 옵션을 찾을 수 없습니다"
            )
        
        # 주문된 옵션인지 확인
        from app.models.order import OrderItem
        order_count = self.db.query(OrderItem).filter(
            OrderItem.product_option_id == option_id
        ).count()
        
        if order_count > 0:
            # 주문이 있는 옵션은 비활성화만
            db_option.is_active = False
        else:
            # 주문이 없는 옵션은 소프트 삭제
            db_option.is_deleted = 'Y'
            db_option.is_active = False
        
        self.db.commit()
        return True
    
    def adjust_option_stock(self, adjustment: ProductOptionStockAdjustment) -> ProductOption:
        """상품 옵션 재고 조정"""
        db_option = self.db.query(ProductOption).filter(
            ProductOption.id == adjustment.option_id,
            ProductOption.is_deleted == 'N'
        ).first()
        
        if not db_option:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="상품 옵션을 찾을 수 없습니다"
            )
        
        new_stock = db_option.current_stock + adjustment.quantity
        if new_stock < 0:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail=f"재고가 부족합니다. 현재 재고: {db_option.current_stock}, 요청 조정: {adjustment.quantity}"
            )
        
        db_option.current_stock = new_stock
        self.db.commit()
        self.db.refresh(db_option)
        
        return db_option
    
    def calculate_price(self, product_id: int, option_id: Optional[int] = None) -> PriceCalculationResponse:
        """상품 가격 계산 (옵션 포함)"""
        product = self.get_product_by_id(product_id)
        if not product:
            raise HTTPException(
                status_code=status.HTTP_404_NOT_FOUND,
                detail="상품을 찾을 수 없습니다"
            )
        
        base_price = product.base_price
        option_price_adjustment = 0
        option_name = None
        
        if option_id:
            option = self.db.query(ProductOption).filter(
                ProductOption.id == option_id,
                ProductOption.product_id == product_id,
                ProductOption.is_deleted == 'N',
                ProductOption.is_active == True
            ).first()
            
            if not option:
                raise HTTPException(
                    status_code=status.HTTP_404_NOT_FOUND,
                    detail="상품 옵션을 찾을 수 없습니다"
                )
            
            option_price_adjustment = option.price_adjustment
            option_name = option.option_name
        
        final_price = base_price + option_price_adjustment
        
        return PriceCalculationResponse(
            base_price=base_price,
            option_price_adjustment=option_price_adjustment,
            final_price=final_price,
            option_name=option_name
        )

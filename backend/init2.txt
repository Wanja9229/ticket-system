-- ========================================
-- 1단계: 사용자 생성 및 데이터베이스 생성
-- postgres 관리자 계정으로 실행
-- ========================================


-- 사용자 생성
CREATE USER ticket_user WITH PASSWORD '1234';

-- 사용자에게 데이터베이스 생성 권한 부여
ALTER USER ticket_user CREATEDB;


-- 데이터베이스 및 스키마 권한 부여
GRANT ALL PRIVILEGES ON DATABASE ticket_system TO ticket_user;

-- 확인
SELECT 
    'ticket_user 사용자 생성 완료' as status,
    'ticket_system 데이터베이스 생성 완료' as database_status;

-- ========================================
-- 2단계: 확장 기능 및 함수 생성
-- ticket_system 데이터베이스에서 실행
-- ========================================

-- 확장 기능 활성화
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- 공통 함수 생성
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

SELECT '확장 기능 및 함수 생성 완료' as status;

-- ========================================
-- 3단계: 테이블 생성 (1/3)
-- ticket_system 데이터베이스에서 실행
-- ========================================

-- 슈퍼 관리자 테이블
CREATE TABLE super_admins (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 이벤트 테이블
CREATE TABLE events (
    id SERIAL PRIMARY KEY,
    event_code VARCHAR(20) UNIQUE NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    image_url VARCHAR(500),
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    is_active BOOLEAN DEFAULT true,
    is_deleted CHAR(1) DEFAULT 'N',
    created_by INTEGER REFERENCES super_admins(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_events_date_range CHECK (end_date >= start_date),
    CONSTRAINT chk_events_is_deleted CHECK (is_deleted IN ('Y', 'N'))
);

-- 이벤트 관리자 테이블
CREATE TABLE event_managers (
    id SERIAL PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES events(id),
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    permission_level INTEGER DEFAULT 2,
    is_active BOOLEAN DEFAULT true,
    is_deleted CHAR(1) DEFAULT 'N',
    created_by INTEGER REFERENCES super_admins(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_event_managers_permission CHECK (permission_level BETWEEN 1 AND 9),
    CONSTRAINT chk_event_managers_is_deleted CHECK (is_deleted IN ('Y', 'N'))
);

-- 고객 테이블
CREATE TABLE customers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

SELECT '기본 테이블 (1/3) 생성 완료' as status;

-- ========================================
-- 4단계: 테이블 생성 (2/3)
-- ticket_system 데이터베이스에서 실행
-- ========================================

-- 상품 테이블
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES events(id),
    name VARCHAR(200) NOT NULL,
    description TEXT,
    base_price DECIMAL(10, 2) NOT NULL,
    base_stock INTEGER NOT NULL DEFAULT 0,
    current_stock INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    is_deleted CHAR(1) DEFAULT 'N',
    created_by INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_products_price_positive CHECK (base_price >= 0),
    CONSTRAINT chk_products_stock_non_negative CHECK (base_stock >= 0 AND current_stock >= 0),
    CONSTRAINT chk_products_is_deleted CHECK (is_deleted IN ('Y', 'N'))
);

-- 상품 옵션 테이블
CREATE TABLE product_options (
    id SERIAL PRIMARY KEY,
    product_id INTEGER NOT NULL REFERENCES products(id),
    option_name VARCHAR(100) NOT NULL,
    price_adjustment DECIMAL(10, 2) DEFAULT 0,
    stock_quantity INTEGER NOT NULL DEFAULT 0,
    current_stock INTEGER NOT NULL DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    is_deleted CHAR(1) DEFAULT 'N',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_product_options_stock_non_negative CHECK (stock_quantity >= 0 AND current_stock >= 0),
    CONSTRAINT chk_product_options_is_deleted CHECK (is_deleted IN ('Y', 'N'))
);

-- 주문 테이블
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES events(id),
    customer_id INTEGER NOT NULL REFERENCES customers(id),
    order_number VARCHAR(50) UNIQUE NOT NULL,
    total_amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    visit_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_orders_amount_positive CHECK (total_amount >= 0),
    CONSTRAINT chk_orders_status CHECK (status IN ('pending', 'paid', 'cancelled', 'refunded'))
);

-- 주문 상품 테이블
CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES orders(id),
    product_id INTEGER NOT NULL REFERENCES products(id),
    product_option_id INTEGER REFERENCES product_options(id),
    item_name VARCHAR(200) NOT NULL,
    quantity INTEGER NOT NULL,
    unit_price DECIMAL(10, 2) NOT NULL,
    total_price DECIMAL(10, 2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_order_items_quantity_positive CHECK (quantity > 0),
    CONSTRAINT chk_order_items_price_positive CHECK (unit_price >= 0 AND total_price >= 0)
);

SELECT '주문 관련 테이블 (2/3) 생성 완료' as status;

-- ========================================
-- 5단계: 테이블 생성 (3/3)
-- ticket_system 데이터베이스에서 실행
-- ========================================

-- 결제 테이블
CREATE TABLE payments (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES orders(id),
    payment_key VARCHAR(100) UNIQUE NOT NULL,
    payment_method VARCHAR(50) NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    toss_payment_id VARCHAR(100),
    payment_data JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_payments_amount_positive CHECK (amount >= 0),
    CONSTRAINT chk_payments_status CHECK (status IN ('pending', 'success', 'failed', 'cancelled'))
);

-- QR 티켓 테이블
CREATE TABLE qr_tickets (
    id SERIAL PRIMARY KEY,
    order_id INTEGER NOT NULL REFERENCES orders(id),
    order_item_id INTEGER NOT NULL REFERENCES order_items(id),
    qr_code VARCHAR(100) UNIQUE NOT NULL,
    ticket_type VARCHAR(50) NOT NULL,
    is_used BOOLEAN DEFAULT false,
    used_at TIMESTAMP,
    used_by INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 공지사항 테이블
CREATE TABLE notices (
    id SERIAL PRIMARY KEY,
    event_id INTEGER NOT NULL REFERENCES events(id),
    title VARCHAR(300) NOT NULL,
    content TEXT NOT NULL,
    is_pinned BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    created_by INTEGER NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 공지사항 첨부파일 테이블
CREATE TABLE notice_files (
    id SERIAL PRIMARY KEY,
    notice_id INTEGER NOT NULL REFERENCES notices(id) ON DELETE CASCADE,
    original_filename VARCHAR(255) NOT NULL,
    stored_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_notice_files_size_positive CHECK (file_size > 0)
);

-- 입장 로그 테이블
CREATE TABLE entrance_logs (
    id SERIAL PRIMARY KEY,
    qr_ticket_id INTEGER NOT NULL REFERENCES qr_tickets(id),
    processed_by INTEGER NOT NULL,
    entrance_type VARCHAR(20) DEFAULT 'normal',
    device_info TEXT,
    processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT chk_entrance_logs_entrance_type CHECK (entrance_type IN ('normal', 'invitation'))
);

SELECT '결제 및 로그 테이블 (3/3) 생성 완료' as status;

-- ========================================
-- 6단계: 인덱스 생성
-- ticket_system 데이터베이스에서 실행
-- ========================================

-- 슈퍼 관리자 인덱스
CREATE INDEX idx_super_admins_username ON super_admins(username);
CREATE INDEX idx_super_admins_email ON super_admins(email);
CREATE INDEX idx_super_admins_active ON super_admins(is_active);

-- 이벤트 인덱스
CREATE UNIQUE INDEX idx_events_code_active ON events(event_code) WHERE is_deleted = 'N';
CREATE INDEX idx_events_active ON events(is_active, is_deleted);
CREATE INDEX idx_events_date_range ON events(start_date, end_date);

-- 이벤트 관리자 인덱스
CREATE UNIQUE INDEX idx_event_managers_username_active ON event_managers(username) WHERE is_deleted = 'N';
CREATE UNIQUE INDEX idx_event_managers_email_active ON event_managers(email) WHERE is_deleted = 'N';
CREATE INDEX idx_event_managers_event ON event_managers(event_id, is_deleted);

-- 고객 인덱스
CREATE UNIQUE INDEX idx_customers_phone ON customers(phone);
CREATE INDEX idx_customers_email ON customers(email);

-- 상품 인덱스
CREATE INDEX idx_products_event ON products(event_id, is_deleted);
CREATE INDEX idx_products_active ON products(is_active, is_deleted);
CREATE INDEX idx_product_options_product ON product_options(product_id, is_deleted);

-- 주문 인덱스
CREATE INDEX idx_orders_event ON orders(event_id);
CREATE INDEX idx_orders_customer ON orders(customer_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);

-- QR 티켓 인덱스
CREATE UNIQUE INDEX idx_qr_tickets_qr_code ON qr_tickets(qr_code);
CREATE INDEX idx_qr_tickets_order ON qr_tickets(order_id);
CREATE INDEX idx_qr_tickets_used ON qr_tickets(is_used, used_at);

-- 공지사항 인덱스
CREATE INDEX idx_notices_event ON notices(event_id, is_active);
CREATE INDEX idx_notices_created_at ON notices(created_at DESC);

SELECT '인덱스 생성 완료' as status;

-- ========================================
-- 7단계: 트리거 생성
-- ticket_system 데이터베이스에서 실행
-- ========================================

CREATE TRIGGER update_super_admins_updated_at 
    BEFORE UPDATE ON super_admins 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_events_updated_at 
    BEFORE UPDATE ON events 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_event_managers_updated_at 
    BEFORE UPDATE ON event_managers 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_customers_updated_at 
    BEFORE UPDATE ON customers 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_products_updated_at 
    BEFORE UPDATE ON products 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_product_options_updated_at 
    BEFORE UPDATE ON product_options 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_orders_updated_at 
    BEFORE UPDATE ON orders 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_payments_updated_at 
    BEFORE UPDATE ON payments 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_qr_tickets_updated_at 
    BEFORE UPDATE ON qr_tickets 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_notices_updated_at 
    BEFORE UPDATE ON notices 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

SELECT '트리거 생성 완료' as status;

-- ========================================
-- 8단계: 초기 데이터 삽입
-- ticket_system 데이터베이스에서 실행
-- ========================================

-- 슈퍼 관리자 계정 (비밀번호: admin123)
INSERT INTO super_admins (username, email, password_hash, full_name) VALUES
('superadmin', 'super@ticket-system.com', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewEyKZZZNGfwpSre', '시스템 슈퍼 관리자'),
('admin', 'admin@ticket-system.com', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/LewEyKZZZNGfwpSre', '시스템 운영 관리자');

-- 테스트 이벤트
INSERT INTO events (event_code, title, description, start_date, end_date, created_by) VALUES
('AAA', '서울 아트 페어 2025', '2025년 서울에서 열리는 대규모 아트 페어입니다.', '2025-08-01', '2025-08-10', 1),
('BBB', '부산 음악 축제 2025', '2025년 부산에서 열리는 K-POP 음악 축제입니다.', '2025-09-15', '2025-09-17', 1),
('CCC', '대구 푸드 페스티벌 2025', '2025년 대구 특색 음식 축제입니다.', '2025-10-05', '2025-10-07', 1);

-- 이벤트 관리자 (비밀번호: manager123)
INSERT INTO event_managers (event_id, username, email, password_hash, full_name, permission_level, created_by) VALUES
(1, 'manager_aaa', 'manager.aaa@ticket-system.com', '$2b$12$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'AAA 이벤트 담당자', 3, 1),
(2, 'manager_bbb', 'manager.bbb@ticket-system.com', '$2b$12$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'BBB 이벤트 담당자', 3, 1),
(3, 'manager_ccc', 'manager.ccc@ticket-system.com', '$2b$12$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'CCC 이벤트 담당자', 3, 1);

-- 테스트 상품
INSERT INTO products (event_id, name, description, base_price, base_stock, current_stock, created_by) VALUES
(1, 'AAA 일반 입장권', '서울 아트 페어 일반 입장권', 25000, 5000, 5000, 1),
(1, 'AAA VIP 입장권', '서울 아트 페어 VIP 입장권', 50000, 500, 500, 1),
(2, 'BBB 1일권', '부산 음악 축제 1일 입장권', 80000, 10000, 10000, 1),
(2, 'BBB 3일권', '부산 음악 축제 3일 패키지', 200000, 3000, 3000, 1),
(3, 'CCC 일반권', '대구 푸드 페스티벌 입장권', 15000, 8000, 8000, 1);

-- 상품 옵션
INSERT INTO product_options (product_id, option_name, price_adjustment, stock_quantity, current_stock) VALUES
(1, '성인', 0, 3000, 3000),
(1, '청소년', -5000, 1000, 1000),
(1, '어린이', -10000, 1000, 1000),
(2, '성인', 0, 400, 400),
(2, '청소년', -10000, 100, 100);

-- 테스트 고객
INSERT INTO customers (name, phone, email) VALUES
('김철수', '010-1234-5678', 'kim.cs@example.com'),
('이영희', '010-2345-6789', 'lee.yh@example.com'),
('박민수', '010-3456-7890', 'park.ms@example.com');

SELECT 
    '초기 데이터 삽입 완료' as status,
    (SELECT COUNT(*) FROM events) as events_count,
    (SELECT COUNT(*) FROM event_managers) as managers_count,
    (SELECT COUNT(*) FROM products) as products_count;

-- ========================================
-- 9단계: 최종 검증
-- ticket_system 데이터베이스에서 실행
-- ========================================

-- 테이블 목록 확인
SELECT 
    table_name,
    (SELECT COUNT(*) FROM information_schema.columns WHERE table_name = t.table_name) as column_count
FROM information_schema.tables t 
WHERE table_schema = 'public' AND table_type = 'BASE TABLE'
ORDER BY table_name;

-- 사용자 권한 확인
SELECT 
    'ticket_user' as username,
    has_database_privilege('ticket_user', 'ticket_system', 'CONNECT') as can_connect,
    has_schema_privilege('ticket_user', 'public', 'USAGE') as can_use_schema;

-- 최종 결과
SELECT 
    'ticket-system 데이터베이스 설정 완료!' as message,
    'ticket_user / 1234 로 로그인 가능' as login_info,
    '슈퍼관리자: superadmin / admin123' as admin_info;